<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认支付 - 安全支付中心</title>
    <!-- Tailwind CSS 官方最新稳定版 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome 图标库 -->
    <link rel="stylesheet" href="static/css/all.min.css">

    <!-- 自定义配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        gray: {
                            100: '#F7F8FA',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                        }
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .payment-card-active {
                @apply border-primary bg-primary/5;
            }

            .amount-btn-active {
                @apply bg-primary text-white border-primary;
            }

            .btn-gradient {
                @apply bg-gradient-to-r from-primary to-primary/80;
            }

            /* 倒计时数字高亮样式 */
            .countdown-highlight {
                @apply font-bold text-primary px-1;
            }

            /* 过期提示高亮样式 */
            .expired-highlight {
                @apply font-bold text-danger px-1;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-600 min-h-screen flex flex-col">
<!-- 顶部导航栏 -->
<header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <a href="#" class="flex items-center text-gray-600">
            <i class="fa fa-arrow-left text-xl mr-2"></i>
            <span class="text-lg font-medium">返回</span>
        </a>
        <h1 class="text-lg font-semibold text-gray-600">确认支付</h1>
        <div class="w-8"></div> <!-- 占位元素，保持导航栏居中 -->
    </div>
</header>

<!-- 主内容区 -->
<main class="flex-1 container mx-auto px-4 py-6">
    <!-- 支付金额选择 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <h2 class="text-gray-600 font-medium mb-4">选择支付金额</h2>
        <!-- 固定金额按钮组 -->
        <div class="grid grid-cols-3 gap-3 mb-4">
            <button class="amount-btn h-16 border border-gray-200 rounded-lg flex items-center justify-center font-medium transition-all hover:border-primary amount-btn-active"
                    data-amount="50">
                ¥50
            </button>
            <button class="amount-btn h-16 border border-gray-200 rounded-lg flex items-center justify-center font-medium transition-all hover:border-primary"
                    data-amount="100">
                ¥100
            </button>
            <button class="amount-btn h-16 border border-gray-200 rounded-lg flex items-center justify-center font-medium transition-all hover:border-primary"
                    data-amount="200">
                ¥200
            </button>
        </div>
        <!-- 自定义金额输入 -->
        <div class="relative">
            <input
                    type="number"
                    id="customAmount"
                    placeholder="请输入自定义金额（元）"
                    class="w-full h-16 pl-10 pr-4 border border-gray-200 rounded-lg focus:outline-none focus:border-primary transition-all"
                    min="1"
                    step="0.01"
            >
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">¥</span>
        </div>
    </div>

    <!-- 支付方式选择（仅保留支付宝） -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <h2 class="text-gray-600 font-medium mb-4">选择支付方式</h2>
        <div class="space-y-3">
            <!-- 支付宝支付（默认选中） -->
            <label class="payment-card group flex items-center justify-between p-4 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-primary/50 payment-card-active">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white mr-4">
                        <i class="fa-brands fa-alipay text-xl"></i>
                    </div>
                    <span class="text-gray-600 font-medium">支付宝支付</span>
                </div>
                <div class="text-primary">
                    <i class="fa fa-check-circle text-xl"></i>
                </div>
            </label>
        </div>
    </div>

    <!-- 订单信息摘要 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <!-- 账户有效期提示 -->
        <div id="expireNotice" class="mb-6 p-3 bg-gradient-to-r from-warning/10 to-primary/5 border border-warning/20 rounded-lg hidden">
            <div class="flex items-center">
                <i class="fa fa-clock-o text-warning mr-2"></i>
                <span id="expireText" class="text-gray-600 text-sm"></span>
            </div>
        </div>

        <div class="flex items-center justify-between mb-4">
            <h2 class="text-gray-600 font-medium">支付信息</h2>
            <a href="#" class="text-primary text-sm flex items-center">
                查看详情 <i class="fa fa-angle-right ml-1 text-xs"></i>
            </a>
        </div>
        <div class="space-y-3 text-sm">
            <div class="flex justify-between">
                <span class="text-gray-400">支付类型</span>
                <span class="text-gray-600">在线充值</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">账户ID</span>
                <span class="text-gray-600 font-medium" id="accountsId">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">创建时间</span>
                <span class="text-gray-600" id="createTime">2024-05-20 13:14:56</span>
            </div>
        </div>
    </div>

    <!-- 支付须知 -->
    <div class="text-xs text-gray-400 mb-16">
        <p>• 支付超时将自动取消订单，请在5分钟内完成支付</p>
        <p>• 支付成功后金额实时到账，可在"我的账户"中查询</p>
        <p>• 如有疑问，请联系客服：xxxxxxxxxx</p>
    </div>
</main>

<!-- 底部支付按钮 -->
<footer class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] py-4 px-6">
    <div class="container mx-auto flex items-center justify-between">
        <div class="flex items-baseline">
            <span class="text-2xl font-bold text-danger" id="totalAmount">¥50.00</span>
        </div>
        <button class="btn-gradient text-white font-medium py-3 px-12 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 active:translate-y-0"
                id="payBtn">
            立即支付
        </button>
    </div>
</footer>

<!-- 支付成功弹窗 -->
<div id="successModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-8 max-w-[80%] w-[300px] text-center">
        <div class="w-16 h-16 rounded-full bg-success/20 flex items-center justify-center text-success mx-auto mb-4">
            <i class="fa fa-check text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-600 mb-2">支付成功</h3>
        <p class="text-gray-400 mb-6">¥<span id="successAmount">50.00</span> 已成功到账，可前往账户查询</p>
        <button id="closeModal"
                class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all">
            完成
        </button>
    </div>
</div>

<div id="payingModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-8 max-w-[80%] w-[300px] text-center">
        <div class="w-16 h-16 rounded-full bg-success/20 flex items-center justify-center text-success mx-auto mb-4">
            <i class="fa fa-check text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-600 mb-2">正在跳转支付宝</h3>
    </div>
</div>

<!-- 加载弹窗（优化：支持错误展示） -->
<div id="loadingModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-8 max-w-[80%] w-[300px] text-center">
        <!-- 加载/错误图标 -->
        <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4" id="loadingIcon">
            <i class="fa fa-spinner fa-spin text-primary text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-600 mb-2" id="loadingTitle">正在查询账户信息</h3>
        <p class="text-gray-400 mb-6" id="loadingContent">请稍候...</p>
        <!-- 错误时显示关闭按钮 -->
        <button id="closeLoadingModal"
                class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all hidden">
            确认
        </button>
    </div>
</div>

<script>
    console.log("init page")

    // 全局变量存储倒计时定时器
    let countdownTimer = null;
    // 账户信息存储
    let accountInfo = {
        accountsId: '',
        expiredTime: 0
    };

    // 初始化当前时间
    const initCreateTime = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('createTime').textContent = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
    };

    // 格式化时间戳为时分秒
    const formatTime = (seconds) => {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `<span class="countdown-highlight">${h}</span>:<span class="countdown-highlight">${m}</span>:<span class="countdown-highlight">${s}</span>`;
    };

    // 更新倒计时显示
    const updateCountdown = (expiredTime) => {
        const expireText = document.getElementById('expireText');
        const now = Date.now();
        const remaining = Math.floor((expiredTime - now) / 1000);

        if (remaining <= 0) {
            // 已过期
            expireText.innerHTML = `会话已<span class="expired-highlight">过期</span>，无法进行支付`;
            // 禁用支付按钮
            document.getElementById('payBtn').disabled = true;
            document.getElementById('payBtn').classList.add('opacity-50');
            document.getElementById('payBtn').textContent = '会话已过期';
            // 清除定时器
            if (countdownTimer) clearInterval(countdownTimer);
        } else {
            // 未过期，显示倒计时
            expireText.innerHTML = `会话有效期剩余：${formatTime(remaining)}`;
        }
    };

    // 显示/隐藏加载弹窗
    const toggleLoadingModal = (show) => {
        const modal = document.getElementById('loadingModal');
        if (show) {
            modal.classList.remove('hidden');
            // 重置弹窗内容
            document.getElementById('loadingIcon').innerHTML = '<i class="fa fa-spinner fa-spin text-primary text-2xl"></i>';
            document.getElementById('loadingIcon').className = 'w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4';
            document.getElementById('loadingTitle').textContent = '正在查询账户信息';
            document.getElementById('loadingContent').textContent = '请稍候...';
            document.getElementById('loadingContent').className = 'text-gray-400 mb-6';
            // document.getElementById('closeLoadingModal').classList.add('hidden');
        } else {
            modal.classList.add('hidden');
        }
    };

    // 展示接口错误信息到弹窗
    const showErrorInModal = (errorMsg) => {
        // 修改弹窗图标为错误图标
        document.getElementById('loadingIcon').innerHTML = '<i class="fa fa-exclamation-circle text-danger text-2xl"></i>';
        document.getElementById('loadingIcon').className = 'w-16 h-16 rounded-full bg-danger/10 flex items-center justify-center mx-auto mb-4';
        // 修改标题和内容
        document.getElementById('loadingTitle').textContent = '查询失败';
        document.getElementById('loadingContent').textContent = errorMsg;
        document.getElementById('loadingContent').className = 'text-danger mb-6';
        // 显示关闭按钮
        // document.getElementById('closeLoadingModal').classList.remove('hidden');
    };

    // 调用获取账户信息的接口
    const fetchAccountInfo = async () => {
        // 显示加载弹窗
        toggleLoadingModal(true);

        try {
            const sign = getUrlParams('sign') || '';
            const apiUrl = `https://zd-iot.here.link/herelink-bill/api/lock/profit/web/pay/getAccountInfo?token=${sign}`;

            // 发起POST请求
            const response = await fetch(apiUrl, {
                method: 'POST',
                // 根据实际需求添加headers（如需要）
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                if (result.errorCode === 0 && result.data) {
                    // 存储账户信息
                    accountInfo.accountsId = result.data.accountsId || '';
                    // 转换过期时间为时间戳
                    accountInfo.expiredTime = typeof result.data.expiredTime === 'string'
                        ? new Date(result.data.expiredTime).getTime()
                        : result.data.expiredTime;

                    // 更新账户ID展示（核心修改：赋值到账户ID字段）
                    document.getElementById('accountsId').textContent = accountInfo.accountsId || '-';

                    // 初始化倒计时
                    updateCountdown(accountInfo.expiredTime);

                    // 显示页面的过期提示区域
                    document.getElementById('expireNotice').classList.remove('hidden');

                    // 设置定时器，每秒更新一次倒计时
                    countdownTimer = setInterval(() => {
                        updateCountdown(accountInfo.expiredTime);
                    }, 1000);

                    // 加载成功后自动关闭弹窗
                    setTimeout(() => {
                        toggleLoadingModal(false);
                    }, 500);

                } else {
                    // 接口返回错误
                    showErrorInModal(result.message || '获取账户信息失败：未知错误');
                }
            } else {
                // 接口请求失败（状态码非200）
                showErrorInModal(`接口请求失败：${response.status} ${response.statusText}`);
            }
        } catch (error) {
            // 网络异常
            console.error('获取账户信息出错:', error);
            showErrorInModal('网络异常，无法连接到服务器，请检查网络后重试');
        }
    };

    // 初始化页面
    const initPage = () => {
        initCreateTime();
        // 加载页面时立即调用账户信息接口
        fetchAccountInfo();
    };

    // 金额选择逻辑
    const amountBtns = document.querySelectorAll('.amount-btn');
    const customAmountInput = document.getElementById('customAmount');
    const totalAmountEl = document.getElementById('totalAmount');
    const successAmountEl = document.getElementById('successAmount');
    let selectedAmount = 50; // 默认选中50元

    // 固定金额按钮点击
    amountBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            amountBtns.forEach(b => b.classList.remove('amount-btn-active'));
            btn.classList.add('amount-btn-active');
            selectedAmount = Number(btn.dataset.amount);
            totalAmountEl.textContent = `¥${selectedAmount.toFixed(2)}`;
            successAmountEl.textContent = selectedAmount.toFixed(2);
            customAmountInput.value = '';
        });
    });

    // 自定义金额输入
    customAmountInput.addEventListener('input', (e) => {
        const value = Number(e.target.value);
        if (!isNaN(value) && value > 0) {
            selectedAmount = value;
            totalAmountEl.textContent = `¥${selectedAmount.toFixed(2)}`;
            successAmountEl.textContent = selectedAmount.toFixed(2);
            amountBtns.forEach(btn => btn.classList.remove('amount-btn-active'));
        } else if (e.target.value === '') {
            selectedAmount = 50;
            amountBtns[0].classList.add('amount-btn-active');
            totalAmountEl.textContent = `¥${selectedAmount.toFixed(2)}`;
            successAmountEl.textContent = selectedAmount.toFixed(2);
        }
    });

    // 支付按钮点击事件
    const payBtn = document.getElementById('payBtn');
    const successModal = document.getElementById('successModal');
    const payingModal = document.getElementById('payingModal');
    const closeModal = document.getElementById('closeModal');

    payBtn.addEventListener('click', () => {
        if (selectedAmount <= 0) {
            alert('请输入有效的支付金额');
            return;
        }

        // 检查账户是否过期
        const now = Date.now();
        if (accountInfo.expiredTime && now >= accountInfo.expiredTime) {
            alert('会话户已过期，无法进行支付');
            return;
        }

        const sign = getUrlParams("sign");
        payBtn.disabled = true;
        payBtn.textContent = '支付中...';

        fetch("https://zd-iot.here.link/herelink-bill/api/lock/profit/web/pay", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "sign": sign,
                "totalAmount": selectedAmount,
                "quitUrl": "https://pay.here.link/"
            })
        }).then(async res => {
            if (res.ok && res.status === 200) {
                const json = await res.json();
                if (json.errorCode === 0) {
                    payingModal.classList.remove('hidden');
                    submitAlipayForm(json.data)
                } else {
                    alert('发起支付失败:' + json.message);
                }
            } else {
                alert('发起支付失败');
            }
            payBtn.disabled = false;
            payBtn.textContent = '立即支付';
        }).catch(err => {
            alert('发起支付失败' + err);
            payBtn.disabled = false;
            payBtn.textContent = '立即支付';
        })
    });

    // 拉起支付宝
    function submitAlipayForm(formStr) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formStr;

        const form = document.createElement('form');
        form.action = tempDiv.querySelector('form').action;
        form.method = tempDiv.querySelector('form').method || 'POST';
        form.style.display = 'none';

        const inputs = tempDiv.querySelectorAll('input');
        inputs.forEach(input => {
            const newInput = document.createElement('input');
            newInput.type = 'hidden';
            newInput.name = input.name;
            newInput.value = input.value;
            form.appendChild(newInput);
        });

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }

    // 获取URL参数
    function getUrlParams(paramKey) {
        const searchParams = window.location.search.slice(1);
        if (!searchParams) return paramKey ? null : {};

        const params = {};
        searchParams.split('&').forEach(item => {
            const [key, value = ''] = item.split('=');
            params[decodeURIComponent(key)] = decodeURIComponent(value);
        });

        return paramKey ? params[paramKey] || null : params;
    }

    // 关闭支付成功弹窗
    closeModal.addEventListener('click', () => {
        successModal.classList.add('hidden');
    });

    // 关闭加载/错误弹窗
    document.getElementById('closeLoadingModal').addEventListener('click', () => {
        toggleLoadingModal(false);
    });

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', initPage);

    // 页面卸载时清除定时器
    window.addEventListener('beforeunload', () => {
        if (countdownTimer) clearInterval(countdownTimer);
    });
</script>
</body>
</html>
